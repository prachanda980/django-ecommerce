{% extends 'base.html' %}
{% load static %}

{% block title %}Order #{{ order.order_number }} - FastShop{% endblock %}

{% block content %}
<div class="min-h-screen py-6 md:py-12 px-3 md:px-6 bg-slate-950" 
     x-data="{ 
        cancelModal: false, 
        reviewModal: false,
        selectedProduct: { name: '', image: '' },
        submitUrl: '',
        rating: 0,
        hoverRating: 0
     }">
     
    <div class="max-w-4xl mx-auto">
        
        <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 text-center md:text-left">
            <div class="w-full md:w-auto">
                <h1 class="text-2xl md:text-4xl font-black text-white tracking-tight break-all">
                    Order #{{ order.order_number|slice:"-8:" }}
                </h1>
                <p class="text-sm md:text-lg text-gray-400 font-medium mt-1">
                    Placed on {{ order.created_at|date:"M j, Y" }}
                </p>
            </div>
            
            <div class="flex flex-wrap justify-center gap-3 w-full md:w-auto">
                <div class="px-4 py-1.5 md:px-5 md:py-2 rounded-full text-xs md:text-sm font-black text-white shadow-xl uppercase tracking-wider
                            {% if order.status == 'delivered' %}bg-emerald-600
                            {% elif order.status == 'cancelled' %}bg-red-600
                            {% elif order.status == 'shipped' %}bg-purple-600
                            {% elif order.status == 'confirmed' %}bg-indigo-600
                            {% else %}bg-amber-600{% endif %}">
                    {{ order.status }}
                </div>
                {% if order.status == 'pending' or order.status == 'confirmed' %}
                    <button @click="cancelModal = true" class="px-4 py-1.5 md:px-5 md:py-2 bg-red-600/10 hover:bg-red-600 text-red-500 hover:text-white border border-red-600/20 font-bold rounded-full transition-all text-xs md:text-sm whitespace-nowrap">
                        Cancel Order
                    </button>
                {% endif %}
            </div>
        </div>

        {% if order.status != 'cancelled' %}
            <div class="mb-8 md:mb-10 px-2">
                <div class="overflow-hidden h-2 mb-4 flex rounded-full bg-slate-800 shadow-inner">
                    <div class="bg-gradient-to-r from-indigo-600 to-purple-600 transition-all duration-1000 ease-out"
                         style="width: {% if order.status == 'pending' %}25%{% elif order.status == 'confirmed' %}50%{% elif order.status == 'shipped' %}75%{% elif order.status == 'delivered' %}100%{% else %}0%{% endif %}"></div>
                </div>
                <div class="grid grid-cols-4 text-[10px] md:text-xs font-black uppercase tracking-widest text-center">
                    <div class="{% if order.status == 'pending' %}text-indigo-400{% else %}text-gray-600{% endif %}">Pending</div>
                    <div class="{% if order.status == 'confirmed' %}text-indigo-400{% else %}text-gray-600{% endif %}">Confirmed</div>
                    <div class="{% if order.status == 'shipped' %}text-indigo-400{% else %}text-gray-600{% endif %}">Shipped</div>
                    <div class="{% if order.status == 'delivered' %}text-indigo-400{% else %}text-gray-600{% endif %}">Delivered</div>
                </div>
            </div>
        {% endif %}

        <div class="bg-slate-900/40 backdrop-blur-md rounded-2xl md:rounded-3xl border border-slate-800 shadow-2xl overflow-hidden">
            <div class="divide-y divide-slate-800">
                {% for item in order.items.all %}
                    <div class="p-4 md:p-6">
                        <div class="flex gap-4">
                            <div class="flex-shrink-0">
                                {% if item.product.images.first %}
                                    <img src="{{ item.product.images.first.image.url }}" 
                                         class="w-20 h-20 md:w-24 md:h-24 rounded-xl object-cover border border-slate-700 bg-slate-800" 
                                         alt="{{ item.product.name }}">
                                {% else %}
                                    <div class="w-20 h-20 md:w-24 md:h-24 bg-slate-800 rounded-xl flex items-center justify-center border border-slate-700">
                                        <i class="fas fa-image text-slate-600 text-2xl"></i>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="flex-1 min-w-0 flex flex-col">
                                <div class="flex flex-col md:flex-row md:justify-between md:items-start gap-1 md:gap-4">
                                    <h4 class="text-sm md:text-lg font-bold text-white leading-tight break-words pr-2">
                                        {{ item.product.name }}
                                    </h4>
                                    <p class="text-base md:text-xl font-black text-white whitespace-nowrap mt-1 md:mt-0">
                                        Rs: {{ item.subtotal }}
                                    </p>
                                </div>

                                <p class="text-xs md:text-sm text-gray-500 font-bold uppercase tracking-tight mt-1">
                                    {{ item.quantity }} Ã— <span class="text-indigo-400">Rs: {{ item.unit_price }}</span>
                                </p>

                                <div class="mt-4 md:mt-auto flex justify-end">
                                    {% if order.status == 'delivered' %}
                                        <button @click="
                                            reviewModal = true; 
                                            rating = 0;
                                            submitUrl = '{% url 'products:submit_review' item.product.slug %}';
                                            selectedProduct = { 
                                                name: '{{ item.product.name|escapejs }}', 
                                                image: '{% if item.product.images.first %}{{ item.product.images.first.image.url }}{% endif %}'
                                            }" 
                                            class="w-full md:w-auto flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-800 hover:bg-slate-700 text-indigo-400 hover:text-white border border-indigo-500/30 rounded-lg transition-all text-xs font-bold uppercase tracking-wide shadow-lg">
                                            <i class="fas fa-star text-amber-400"></i> Rate Product
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="bg-slate-800/30 p-5 md:p-8 border-t border-slate-800">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-4">
                        <div>
                            <h4 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-2 flex items-center gap-2">
                                <i class="fas fa-truck text-indigo-500"></i> Shipping Address
                            </h4>
                            <p class="text-sm text-gray-300 leading-relaxed font-medium break-words">
                                {{ order.shipping_address }}
                            </p>
                        </div>
                        <div>
                            <h4 class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1 flex items-center gap-2">
                                <i class="fas fa-credit-card text-indigo-500"></i> Payment
                            </h4>
                            <p class="text-sm text-gray-300 font-bold">{{ order.payment_method|title|cut:"_" }}</p>
                        </div>
                    </div>
                    
                    <div class="flex flex-col justify-end md:items-end border-t md:border-t-0 border-slate-800 pt-6 md:pt-0">
                        <span class="text-xs font-black text-gray-500 uppercase tracking-widest mb-1">Order Total</span>
                        <p class="text-3xl sm:text-4xl md:text-5xl font-black text-indigo-400 tracking-tighter break-all">
                            Rs: {{ order.total }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template x-teleport="body">
        <div x-show="reviewModal" 
             class="fixed inset-0 z-[100] flex items-end md:items-center justify-center bg-black/80 backdrop-blur-sm"
             x-transition.opacity
             x-cloak>
            
            <div @click.away="reviewModal = false" 
                 class="w-full max-w-[95vw] md:max-w-md bg-slate-900 border-t md:border border-slate-800 p-5 md:p-8 rounded-t-3xl md:rounded-3xl shadow-2xl relative mx-auto"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-y-full md:translate-y-10 md:opacity-0"
                 x-transition:enter-end="translate-y-0 md:opacity-100">

                <div class="w-12 h-1.5 bg-slate-700 rounded-full mx-auto mb-5 md:hidden"></div>

                <div class="text-center mb-5">
                    <div class="w-14 h-14 md:w-16 md:h-16 bg-slate-800 rounded-2xl mx-auto mb-3 flex items-center justify-center overflow-hidden border border-slate-700">
                        <template x-if="selectedProduct.image">
                            <img :src="selectedProduct.image" class="w-full h-full object-cover">
                        </template>
                        <template x-if="!selectedProduct.image">
                            <i class="fas fa-box text-indigo-400 text-2xl"></i>
                        </template>
                    </div>
                    <h3 class="text-lg font-bold text-white leading-tight">Rate Product</h3>
                    <p class="text-sm text-gray-400 mt-1 px-2 line-clamp-2 max-w-full break-words" x-text="selectedProduct.name"></p>
                </div>

                <form method="POST" :action="submitUrl" class="space-y-5">
                    {% csrf_token %}
                    
                    <input type="hidden" name="rating" :value="rating" required>

                    <!-- Responsive Rating Stars - FIXED -->
                    <div class="flex justify-center items-center mb-2 overflow-hidden">
                        <div class="flex justify-center items-center gap-2 sm:gap-3 md:gap-4 flex-shrink-0">
                            <template x-for="i in 5">
                                <button type="button" 
                                        @click="rating = i" 
                                        @mouseover="hoverRating = i" 
                                        @mouseleave="hoverRating = 0"
                                        class="transition-transform duration-150 active:scale-95 focus:outline-none flex-shrink-0"
                                        :class="(hoverRating || rating) >= i ? 'text-amber-400 drop-shadow-[0_0_8px_rgba(251,191,36,0.4)]' : 'text-slate-700'">
                                    <!-- Responsive star sizes that fit in container -->
                                    <i class="fas fa-star text-2xl sm:text-3xl md:text-4xl"></i>
                                </button>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Rating validation message -->
                    <div x-show="rating === 0" class="text-center text-red-400 text-xs font-medium h-4">
                        Tap a star to rate
                    </div>

                    <!-- Review textarea -->
                    <textarea name="comment" rows="3" required placeholder="Write your review here..." 
                              class="w-full bg-slate-800 border border-slate-700 rounded-xl p-4 text-white placeholder-gray-500 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 resize-none text-sm"></textarea>

                    <!-- Action buttons -->
                    <div class="flex flex-col gap-3">
                        <button type="submit" 
                                :disabled="rating === 0"
                                :class="rating === 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-indigo-500 shadow-indigo-500/20'"
                                class="w-full py-3.5 bg-indigo-600 text-white font-bold rounded-xl shadow-lg transition-all text-sm uppercase tracking-wide">
                            Submit Review
                        </button>
                        
                        <button type="button" @click="reviewModal = false" class="w-full py-3 text-slate-400 hover:text-white font-medium text-sm">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </template>

    <template x-teleport="body">
        <div x-show="cancelModal" 
             class="fixed inset-0 z-[100] flex items-end md:items-center justify-center bg-black/80 backdrop-blur-sm"
             x-transition.opacity
             x-cloak>
            
            <div @click.away="cancelModal = false" 
                 class="w-full max-w-[95vw] md:max-w-sm bg-slate-900 border-t md:border border-slate-800 p-6 md:p-8 rounded-t-3xl md:rounded-[2.5rem] shadow-2xl text-center mx-auto"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="translate-y-full md:translate-y-10 md:opacity-0"
                 x-transition:enter-end="translate-y-0 md:opacity-100">
                
                <div class="w-16 h-16 bg-red-500/10 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                </div>
                
                <h3 class="text-xl font-black text-white mb-2">Cancel Order?</h3>
                <p class="text-gray-400 text-sm font-medium mb-8">This action cannot be undone. Are you sure?</p>
                
                <div class="flex flex-col gap-3">
                    <form action="{% url 'orders:cancel' order.id %}" method="POST">
                        {% csrf_token %}
                        <button type="submit" class="w-full py-4 bg-red-600 hover:bg-red-700 text-white font-black rounded-xl md:rounded-2xl transition-all shadow-lg shadow-red-600/20 text-sm uppercase tracking-wide">
                            Yes, Cancel Order
                        </button>
                    </form>
                    <button @click="cancelModal = false" class="w-full py-4 bg-slate-800 text-gray-300 font-bold rounded-xl md:rounded-2xl hover:bg-slate-700 transition-all text-sm">
                        Back
                    </button>
                </div>
            </div>
        </div>
    </template>

</div>

<style>
    [x-cloak] { display: none !important; }
    
    /* Prevent horizontal overflow */
    .modal-container {
        max-width: calc(100vw - 20px);
    }
    
    /* Ensure stars don't overflow */
    .stars-container {
        max-width: 100%;
        overflow-x: hidden;
    }
</style>

<script>
    // Calculate safe star size based on screen width
    function calculateStarSize() {
        const screenWidth = window.innerWidth;
        if (screenWidth < 640) { // Mobile
            return 'text-2xl';
        } else if (screenWidth < 768) { // Small tablet
            return 'text-3xl';
        } else if (screenWidth < 1024) { // Tablet
            return 'text-4xl';
        } else { // Desktop
            return 'text-4xl';
        }
    }
    
    // You could use this function to dynamically set star sizes if needed
    document.addEventListener('alpine:init', () => {
        Alpine.data('ratingStars', () => ({
            starSizeClass: calculateStarSize(),
            
            init() {
                // Update star size on window resize
                window.addEventListener('resize', () => {
                    this.starSizeClass = calculateStarSize();
                });
            }
        }));
    });
</script>
{% endblock %}